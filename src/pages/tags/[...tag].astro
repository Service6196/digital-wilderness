---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

export const prerender = true;
// 获取所有文章
const allPosts = await getCollection('posts', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
});

// 获取当前标签
const { tag } = Astro.params;

// 按标签筛选
const filteredPosts = tag 
    ? allPosts.filter(post => post.data.tags?.includes(tag))
    : allPosts;

// 排序
const sortedPosts = filteredPosts.sort((a, b) => 
    b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 获取所有标签及其计数
const allTags = allPosts.flatMap(post => post.data.tags || []);
const tagCounts = allTags.reduce((acc, t) => {
    acc[t] = (acc[t] || 0) + 1;
    return acc;
}, {} as Record<string, number>);

const uniqueTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

// 生成静态路径
export async function getStaticPaths() {
    const posts = await getCollection('posts');
    const allTags = [...new Set(posts.flatMap(post => post.data.tags || []))];
    
    return [
        { params: { tag: undefined } }, // /tags 首页
        ...allTags.map(tag => ({ params: { tag } }))
    ];
}

const formatDate = (date: Date) => {
    return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\//g, '.');
};
---

<BaseLayout title={tag ? `#${tag} | Digital Wilderness` : 'Tags | Digital Wilderness'}>
    
    <main class="pt-[160px] px-[4vw] min-h-screen">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-16 border-b border-[var(--grid-line)] pb-8 gap-6">
            <div>
                {tag ? (
                    <>
                        <a href="/tags" class="font-mono text-xs opacity-50 hover:opacity-100 mb-4 inline-block">&larr; 所有标签</a>
                        <h1 class="text-[clamp(2rem,4vw,3rem)] leading-none font-bold tracking-tighter">
                            #{tag}
                        </h1>
                        <p class="font-mono text-sm opacity-60 mt-2">{sortedPosts.length} 篇文章</p>
                    </>
                ) : (
                    <h1 class="text-[clamp(3rem,6vw,5rem)] leading-none font-bold tracking-tighter">
                        标签 <span class="text-xl md:text-3xl font-light opacity-40 ml-4 font-sans">/ TAGS</span>
                    </h1>
                )}
            </div>
        </div>

        {!tag ? (
            <!-- 标签云 -->
            <div class="flex flex-wrap gap-4 mb-16">
                {uniqueTags.map(([tagName, count]) => (
                    <a 
                        href={`/tags/${tagName}`}
                        class="px-4 py-2 border border-[var(--grid-line)] rounded-full hover:bg-[var(--accent)] hover:text-white hover:border-transparent transition-all group"
                    >
                        <span class="font-medium">#{tagName}</span>
                        <span class="ml-2 opacity-50 group-hover:opacity-80 font-mono text-xs">{count}</span>
                    </a>
                ))}
            </div>
        ) : (
            <!-- 文章列表 -->
            <div class="space-y-0">
                {sortedPosts.map((post) => (
                    <a 
                        href={`/journal/${post.id}`} 
                        class="group flex items-center justify-between border-t border-[var(--grid-line)] py-6 hover:bg-[var(--accent)] hover:text-white transition-colors duration-300 px-4 -mx-4"
                    >
                        <div class="flex-1">
                            <h3 class="text-lg md:text-xl font-medium mb-1">{post.data.title}</h3>
                            <p class="text-sm opacity-60 line-clamp-1">{post.data.description}</p>
                        </div>
                        <div class="flex items-center gap-4 ml-4">
                            <span class="hidden md:block font-mono text-xs opacity-50">{formatDate(post.data.pubDate)}</span>
                            <span class="opacity-0 group-hover:opacity-100 transform translate-x-2 group-hover:translate-x-0 transition-all">
                                &rarr;
                            </span>
                        </div>
                    </a>
                ))}
                <div class="border-t border-[var(--grid-line)]"></div>
            </div>
        )}

        {tag && sortedPosts.length === 0 && (
            <div class="text-center py-24 opacity-60">
                <p class="text-xl mb-4">该标签下暂无文章</p>
                <a href="/tags" class="font-mono text-sm text-[var(--accent)] underline">
                    查看所有标签
                </a>
            </div>
        )}
    </main>

    <Footer />
</BaseLayout>
