---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Footer from '../../components/Footer.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Lightbox from '../../components/Lightbox.astro';
import { getCollection, render } from 'astro:content';

export const prerender = true;
export async function getStaticPaths() {
    const posts = await getCollection('posts');
    return posts.map(post => ({
        params: { slug: post.id },
        props: { post },
    }));
}

const { post } = Astro.props;

// 如果文章不存在，返回404
if (!post) {
    return Astro.redirect('/404');
}

const { Content, headings } = await render(post);

// 格式化日期
const formatDate = (date: Date) => {
    return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\//g, '.');
};

// 估算阅读时间
const wordCount = post.body?.length || 0;
const readTime = Math.max(1, Math.ceil(wordCount / 400));
---

<BaseLayout title={`${post.data.title} | Digital Wilderness`} description={post.data.description}>
    
    <main class="pt-[160px] px-[4vw] min-h-screen">
        <div class="max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-12 relative">
            
            <!-- Article Content -->
            <article class="col-span-1 lg:col-span-8 lg:col-start-2">
                <header class="mb-16">
                    <!-- Meta -->
                    <div class="flex items-center gap-6 font-mono text-xs uppercase tracking-widest opacity-50 mb-8">
                        <span>{post.data.category || '未分类'}</span>
                        <span class="w-1 h-1 bg-current rounded-full"></span>
                        <span>{formatDate(post.data.pubDate)}</span>
                        <span class="w-1 h-1 bg-current rounded-full"></span>
                        <span>{readTime} 分钟阅读</span>
                    </div>
                    
                    <!-- Title -->
                    <h1 class="text-[clamp(2rem,5vw,4rem)] leading-[1.1] font-bold tracking-tight mb-12">
                        {post.data.title}
                    </h1>

                    <!-- Tags -->
                    {post.data.tags && post.data.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2 mb-8">
                            {post.data.tags.map((tag: string) => (
                                <span class="px-3 py-1 bg-[var(--grid-line)] text-xs font-mono rounded-full">
                                    #{tag}
                                </span>
                            ))}
                        </div>
                    )}
                </header>

                <!-- Cover Image -->
                {post.data.heroImage && (
                    <figure class="mb-16 -mx-[4vw] md:mx-0">
                        <img 
                            src={post.data.heroImage} 
                            alt={post.data.title}
                            class="w-full aspect-[16/9] object-cover grayscale hover:grayscale-0 transition-all duration-700 rounded-sm"
                        />
                    </figure>
                )}

                <!-- Content -->
                <div class="prose prose-lg prose-neutral dark:prose-invert max-w-none
                    prose-headings:font-bold prose-headings:tracking-tight prose-headings:scroll-mt-32
                    prose-h2:text-2xl prose-h2:mt-16 prose-h2:mb-6 prose-h2:border-t prose-h2:border-[var(--grid-line)] prose-h2:pt-8
                    prose-p:text-lg prose-p:leading-relaxed prose-p:opacity-80
                    prose-a:text-[var(--accent)] prose-a:no-underline hover:prose-a:underline
                    prose-blockquote:border-l-4 prose-blockquote:border-[var(--accent)] prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-xl
                    prose-code:bg-[var(--grid-line)] prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-sm
                    prose-pre:bg-[var(--grid-line)] prose-pre:border prose-pre:border-[var(--grid-line)]
                    prose-img:rounded-sm
                ">
                    <Content />
                </div>

                <!-- Footer -->
                <footer class="mt-24 pt-12 border-t border-[var(--grid-line)]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8">
                        <div>
                            <p class="font-mono text-xs uppercase tracking-widest opacity-50 mb-2">继续阅读</p>
                            <a href="/journal" class="text-xl font-medium hover:text-[var(--accent)] transition-colors">
                                &larr; 返回日志
                            </a>
                        </div>
                        
                        <div class="flex gap-4">
                            <button class="w-12 h-12 border border-[var(--grid-line)] rounded-full flex items-center justify-center hover:bg-[var(--accent)] hover:text-white hover:border-transparent transition-all" title="分享">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                            </button>
                            <button class="w-12 h-12 border border-[var(--grid-line)] rounded-full flex items-center justify-center hover:bg-[var(--accent)] hover:text-white hover:border-transparent transition-all" title="收藏">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </footer>
            </article>

            <!-- Sidebar TOC -->
            <aside class="hidden lg:col-span-3 lg:block">
                <TableOfContents headings={headings} />
            </aside>
            
        </div>
    </main>

    <!-- 阅读进度条 -->
    <div id="reading-progress" class="fixed top-0 left-0 h-[3px] bg-[var(--accent)] z-[100] transition-all duration-75" style="width: 0%"></div>

    <Footer />
    <Lightbox />
</BaseLayout>

<script>
    function initReadingProgress() {
        const progressBar = document.getElementById('reading-progress');
        const article = document.querySelector('article');
        
        if (!progressBar || !article) return;
        
        function updateProgress() {
            const articleRect = article.getBoundingClientRect();
            const articleTop = articleRect.top + window.scrollY;
            const articleHeight = articleRect.height;
            const windowHeight = window.innerHeight;
            const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
            const progress = Math.min(100, Math.max(0, (scrolled / articleHeight) * 100));
            
            progressBar.style.width = `${progress}%`;
        }
        
        window.addEventListener('scroll', updateProgress, { passive: true });
        updateProgress();
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initReadingProgress);
    } else {
        initReadingProgress();
    }
    document.addEventListener('astro:page-load', initReadingProgress);
</script>
